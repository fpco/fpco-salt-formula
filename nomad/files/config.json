{%- set home = '/var/lib/nomad' %}
{%- set region = salt['pillar.get']('nomad:region', 'us') %}
{%- set dc = salt['pillar.get']('nomad:datacenter', 'dc') %}
{%- set syslog_facility = salt['pillar.get']('nomad:syslog_facility', 'LOCAL0') %}
{%- if salt['pillar.get']('nomad:enable_debug', False) %}{% set enable_debug = 'true' %}
{%- else %}{% set enable_debug = 'false' %}
{%- endif %}
{%- set secret_key = salt['pillar.get']('nomad:secret_key', '') %}
{%- set log_level = salt['pillar.get']('nomad:log_level', 'INFO') %}
{%- set ext_ip = salt['grains.get']('ip4_interfaces')['eth0'][0] %}
{%- set http_ip = ext_ip %}
{%- set default_server = 'nomad-server.service.consul' %}

{#- server-specific #}
{%- set server = salt['pillar.get']('nomad:server', False) %}
{%- set num_schedulers = salt['pillar.get']('nomad:num_schedulers', False) %}
{%- set enabled_schedulers = salt['pillar.get']('nomad:enabled_schedulers', False) %}
{%- set bootstrap_expect = salt['pillar.get']('nomad:bootstrap_expect', 3) %}
{%- set retry_interval = salt['pillar.get']('nomad:retry_interval', '15s') %}
{%- set join_servers = salt['pillar.get']('nomad:servers', [default_server]) %}

{#- agent-specific #}
{#- the agent requires the port when referencing it in the config #}
{%- set default_agent_server = default_server ~ ':4647' %}
{%- set agent_servers = salt['pillar.get']('nomad:servers', [default_agent_server]) %}
{%- set default_node_id = salt['grains.get']('id') %}
{%- set node_id = salt['pillar.get']('nomad:node_id', default_node_id) %}
{%- set node_class = salt['pillar.get']('nomad:node_class', False) %}
{%- set meta = salt['pillar.get']('nomad:meta', {}) %}
{%- set opts = salt['pillar.get']('nomad:options', {}) %}
{%- set net_iface = salt['pillar.get']('nomad:network_interface', False) %}

{#- consul-specific #}
{%- set consul_addr = salt['pillar.get']('nomad:consul:addr', 'localhost:8500') %}
{%- set consul_token = salt['pillar.get']('nomad:consul:token', 'CONSUL_TOKEN_FOR_NOMAD') %}

{%- if server %}
  {#- use external/private IP when running server mode #}
  {%- set rpc_ip = ext_ip %}
  {%- set serf_ip = ext_ip %}
{%- else %}
  {%- set rpc_ip = False %}
  {%- set serf_ip = False %}
{%- endif -%}

{
  "addresses": {
    {%- if serf_ip %}"serf": "{{ serf_ip }}",{% endif %}
    {%- if rpc_ip %}"rpc": "{{ rpc_ip }}",{% endif %}
    "http": "{{ http_ip }}"
  },
  "datacenter": "{{ dc }}",
  "data_dir": "{{ home }}/tmp/",
  "disable_anonymous_signature": true,
  "disable_update_check": true,
  "enable_debug": {{ enable_debug }},
  "enable_syslog": true,
  "log_level": "{{ log_level }}",
  "name": "{{ node_id }}",
  "region": "{{ region }}",
  "syslog_facility": "{{ syslog_facility }}",
  {%- if server %}
  "server": {
    "bootstrap_expect": {{ bootstrap_expect }},
    {%- if num_schedulers %}"num_schedulers": "{{ num_schedulers }}",{% endif %}
    {%- if enabled_schedulers %}"enabled_schedulers": "{{ enabled_schedulers }}",{% endif %}
    "retry_join": [
      {% for s in join_servers %}"{{ s }}"{%- if not loop.last %},{%- endif %}
      {% endfor -%}
    ],
    "retry_interval": "{{ retry_interval }}",
    "enabled": true
  }
  {%- else %}
  "client": {
    "options": {
      "consul.address": "{{ consul_addr }}",
      "consul.token": "{{ consul_token }}",
      {%- for k,v in opts.items() %}
      "{{ k }}": "{{ v }}"{% if not loop.last %},{% endif %}
      {% endfor %}
    },
    "servers": [
      {% for s in agent_servers %}"{{ s }}"{%- if not loop.last %},{%- endif %}
      {% endfor -%}
    ],
    {% if meta %}"meta": { {%- for k,v in meta.items() %}
      "{{ k }}": "{{ v }}"{% if not loop.last %},{% endif %}
    {% endfor %}},{% endif %}
    {% if net_iface %}"network_interface": "{{ net_iface }}",{% endif %}
    {% if node_class %}"node_class": "{{ node_class }}",{% endif %}
    "enabled": true
  }
  {%- endif %}
}
